<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream11 Team Predictor</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js"></script>
    <style>
        /*
         * --- Custom Styles for Dream11 Predictor ---
         * This section enhances the Tailwind CSS with a modern, futuristic theme,
         * including a vibrant color palette, subtle animations, and improved
         * responsiveness and UI elements.
         */
        
        /* Basic font and transition settings for the whole page */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* Defining a vibrant color palette using CSS variables */
        :root {
            /* Light mode colors */
            --bg-color-light: #f3f4f6;
            --card-bg-light: #ffffff;
            --text-color-light: #1f2937;
            --border-color-light: #e5e7eb;
            
            /* Dark mode colors */
            --bg-color-dark: #0a0a0f;
            --card-bg-dark: #13131a;
            --text-color-dark: #e5e7eb;
            --border-color-dark: #374151;
            
            /* Accent colors for buttons, highlights, etc. */
            --accent-primary: #1e88e5; /* A vibrant blue */
            --accent-secondary: #00e676; /* A lively green */
            --accent-error: #ef4444; /* A clear red for errors */
        }
        
        /* Apply colors based on light or dark body class */
        body.light {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        body.dark {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* Tailwind overrides for dark mode to ensure consistency */
        body.dark .bg-white { background-color: var(--card-bg-dark); }
        body.dark .bg-gray-50 { background-color: #1a1a2e; }
        body.dark .border-gray-100 { border-color: var(--border-color-dark); }
        body.dark .border-gray-200 { border-color: #4b5563; }
        body.dark .text-gray-800 { color: var(--text-color-dark); }
        body.dark .text-gray-900 { color: var(--text-color-dark); }
        body.dark .text-gray-600 { color: #a1a1aa; } /* Gray 400 */
        body.dark .text-gray-700 { color: #d4d4d8; } /* Gray 300 */
        body.dark .bg-gray-200 { background-color: #3f3f46; color: #f4f4f5; }
        body.dark .hover\:bg-gray-300:hover { background-color: #52525b; }
        body.dark .bg-gray-100 { background-color: #27272a; }
        body.dark .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45); }
        body.dark #chat-history { background-color: #1a1a2e; }
        body.dark #chat-input { background-color: #27272a; color: var(--text-color-dark); border-color: #4b5563; }
        body.dark #chat-history::-webkit-scrollbar-track { background: #374151; }
        body.dark #chat-history::-webkit-scrollbar-thumb { background: #6b7280; }
        body.dark #chat-history::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        body.dark .bg-indigo-50 { background-color: #1a1a2e; }
        body.dark #error-message { background-color: #fee2e2; color: #b91c1c; }
        
        /* Custom styles for glowing effects on buttons and borders */
        .glow-button {
            position: relative;
            z-index: 10;
            transition: all 0.4s ease;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .glow-button:hover {
            box-shadow: 0 0 15px var(--accent-primary), 0 0 25px var(--accent-primary), 0 0 35px var(--accent-primary);
            transform: translateY(-2px);
        }
        .glow-border {
            box-shadow: 0 0 10px rgba(30, 136, 229, 0.5); /* Semi-transparent glow */
        }
        
        /* Markdown content styling for better readability */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-bottom: 0.75em; margin-top: 1.5em; line-height: 1.2; }
        .markdown-content h1 { font-size: 2.25rem; }
        .markdown-content h2 { font-size: 1.875rem; }
        .markdown-content h3 { font-size: 1.5rem; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content strong { color: var(--accent-secondary); }
        
        /* Custom styles for dark mode toggle switch */
        .slider {
            background-color: #d1d5db;
            transition: .4s;
        }
        .dark .slider {
            background-color: #4b5563;
        }
        .slider:before {
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-primary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Custom scrollbar for a sleek look */
        #chat-history::-webkit-scrollbar { width: 8px; }
        #chat-history::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #chat-history::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        #chat-history::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark #chat-history::-webkit-scrollbar-track { background: #374151; }
        .dark #chat-history::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark #chat-history::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* Modern loading animation */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 12px;
            height: 12px;
            margin: 0 4px;
            background-color: var(--accent-primary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        /* Floating Chat Popup styles */
        #chat-popup-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
        }

        /* Floating button style with text and icon */
        #chat-toggle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* full rounded */
            box-shadow: 0 0 10px var(--accent-secondary);
            background-color: var(--accent-secondary);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        #chat-toggle-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-secondary), 0 0 25px var(--accent-secondary), 0 0 35px var(--accent-secondary);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--accent-secondary); }
            50% { box-shadow: 0 0 20px var(--accent-secondary), 0 0 30px var(--accent-secondary); }
        }
        
        #chat-popup-window {
            width: 100%;
            max-width: 400px;
            height: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg-light);
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color-light);
            transition: all 0.3s ease-in-out;
            transform-origin: bottom right;
        }

        /* Dark mode specific for the chat popup */
        body.dark #chat-popup-window {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45);
        }
        
        /* New classes for animation */
        .chat-hidden {
            opacity: 0;
            transform: scale(0.8);
            visibility: hidden;
            pointer-events: none;
        }
        .chat-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
            pointer-events: auto;
        }

        /* Responsive adjustments for the floating chat */
        @media (max-width: 768px) {
            #chat-popup-container {
                bottom: 1rem;
                right: 1rem;
            }
            #chat-popup-window {
                width: calc(100vw - 2rem);
                max-width: none;
                height: calc(100vh - 2rem);
            }
            /* Hide text on floating button on smaller screens */
            #chat-toggle-button span {
                display: none;
            }
            #chat-toggle-button {
                padding: 0.75rem;
            }
        }
        
        /* New chat message styles */
        .chat-message {
            margin-bottom: 0.75rem; /* 12px */
            padding: 1rem; /* 16px */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            word-break: break-word;
            transition: all 0.3s ease;
            transform: scale(0.95);
            transform-origin: bottom;
            max-width: 85%;
        }

        .chat-message.user {
            background-color: #e0f2fe; /* Light blue */
            color: #1e40af; /* Dark blue */
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* 8px */
        }
        body.dark .chat-message.user {
            background-color: #1a237e; /* Darker blue */
            color: #e0e7ff; /* Lighter blue */
        }

        .chat-message.ai {
            background-color: #f3f4f6; /* Light gray */
            color: #374151; /* Dark gray */
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* 8px */
        }
        body.dark .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: #f9fafb; /* Lighter gray */
        }
        
    </style>
</head>
<body class="antialiased dark">

    <!-- Main container with fluid padding for responsiveness -->
    <div class="container mx-auto p-4 md:p-8 lg:p-12 min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12 border border-gray-100 transition-colors duration-300 w-full max-w-6xl glow-border">
            
            <!-- Header Section with Dark Mode Toggle -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10">
                <div class="text-left mb-4 md:mb-0">
                    <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                        Dream11 Predictor ⚡
                    </h1>
                    <p class="text-lg md:text-xl text-gray-600 mt-2">
                        Analyze data and craft your winning team with AI.
                    </p>
                </div>
                <div class="flex items-center space-x-2 mt-4 md:mt-0">
                    <span class="text-gray-500 text-sm">Light</span>
                    <label class="switch relative inline-block w-14 h-8">
                        <input type="checkbox" id="dark-mode-toggle" class="opacity-0 w-0 h-0">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:rounded-full"></span>
                    </label>
                    <span class="text-gray-500 text-sm">Dark</span>
                </div>
            </div>

            <!-- Main Content Area with responsive columns -->
            <div class="flex flex-col gap-8">
                <!-- Prediction Output -->
                <div class="flex-1">
                    
                    <!-- Upload and Preview Section -->
                    <div class="bg-gray-50 rounded-2xl p-6 sm:p-8 mb-4 border-2 border-dashed border-gray-200 transition-all duration-300 hover:bg-gray-100">
                        <label for="image-upload" class="cursor-pointer block">
                            <div class="flex flex-col items-center justify-center p-4 sm:p-6 text-center">
                                <i data-lucide="upload-cloud" class="w-12 h-12 sm:w-14 sm:h-14 text-indigo-500 animate-pulse"></i>
                                <p class="mt-4 text-sm text-gray-600">
                                    <span class="font-semibold text-indigo-600 hover:text-indigo-700 transition-colors">
                                        Click to upload
                                    </span>
                                    or drag and drop your image
                                </p>
                                <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 10MB</p>
                            </div>
                        </label>
                        <input type="file" id="image-upload" accept="image/*" class="hidden">
                    </div>

                    <div id="preview-container" class="mb-4 hidden transition-opacity duration-300">
                        <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-700">Image Preview:</h2>
                        <img id="image-preview" src="#" alt="Image Preview" class="w-full max-h-80 sm:max-h-96 object-contain rounded-xl shadow-lg border border-gray-200">
                    </div>

                    <!-- Action and Status Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-8">
                        <button id="analyze-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-indigo-400 disabled:cursor-not-allowed transform hover:scale-105 glow-button" style="--accent-primary: #1e88e5;">
                            Analyze and Predict
                        </button>
                        <button id="clear-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-gray-200 text-gray-800 font-bold shadow-lg hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 transition-all duration-300 transform hover:scale-105">
                            Clear All
                        </button>
                    </div>

                    <!-- AI Response Section -->
                    <div id="results-container" class="hidden transition-opacity duration-300">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700 border-b-2 border-indigo-500 pb-2">AI's Dream11 Prediction:</h2>
                        <div id="loading-indicator" class="hidden text-center text-gray-500 text-sm py-8">
                             <!-- Modern loader animation -->
                             <div class="loader-container">
                                <div class="loader-dot"></div>
                                <div class="loader-dot"></div>
                                <div class="loader-dot"></div>
                             </div>
                            <span class="mt-4 block">Analyzing the image and generating the team...</span>
                        </div>
                        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-xl relative shadow-md" role="alert">
                            <span class="block sm:inline" id="error-text"></span>
                        </div>
                        <div id="prediction-output" class="p-6 bg-gray-100 rounded-xl border border-gray-200 text-base shadow-inner markdown-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Chat Popup -->
    <div id="chat-popup-container">
        <!-- Floating button to open the chat -->
        <button id="chat-toggle-button" class="group">
            <i data-lucide="message-square" class="w-6 h-6 text-white transition-transform duration-300 group-hover:rotate-12"></i>
            <span class="ml-2">Chat with AI</span>
        </button>

        <!-- The actual chat popup window -->
        <div id="chat-popup-window" class="chat-hidden fixed bottom-24 right-4 md:right-8 lg:right-12 flex-col">
            <!-- Header for the chat popup -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 rounded-t-2xl bg-gray-50 dark:bg-gray-800">
                <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Chat with AI</h2>
                <button id="chat-close-button" aria-label="Close Chat" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Chat history div with a minimum height and scroll -->
            <div id="chat-history" class="p-4 overflow-y-auto flex-1 flex flex-col">
                <!-- Chat messages will be appended here -->
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-1 p-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Ask a follow-up question...">
                    <button id="send-chat-btn" aria-label="Send Message" class="flex items-center justify-center w-12 h-12 rounded-full bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-indigo-400 disabled:cursor-not-allowed glow-button" style="--accent-primary: #1e88e5;">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        // JavaScript for handling image upload, API call, and chat functionality
        
        // This function call is from the Lucide Icon library to replace all `<i>` tags with the corresponding SVG icons
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        window.addEventListener('load', () => {
             // Create icons on initial page load for the main UI
             createIcons();
        });

        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const previewContainer = document.getElementById('preview-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const predictionOutput = document.getElementById('prediction-output');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Dark Mode elements
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Chat elements
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const chatPopupWindow = document.getElementById('chat-popup-window');
        const chatCloseButton = document.getElementById('chat-close-button');
        const chatHistoryDiv = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        
        let base64Image = null;
        let chatHistory = [];

        // Dark Mode Initialization and Listener
        // Set dark mode as default if not already set in local storage
        if (localStorage.getItem('dark-mode') === null) {
            localStorage.setItem('dark-mode', 'true');
        }
        
        const isDarkMode = localStorage.getItem('dark-mode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark');
                localStorage.setItem('dark-mode', 'true');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('dark-mode', 'false');
            }
        });

        // Function to convert an image file to a Base64 string
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // Function to display an error message
        function showError(message) {
            errorText.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        
        // Function to append a message to the chat history
        function appendChatMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            // Use marked.js to parse the Markdown content
            const htmlContent = marked.parse(text);
            
            messageDiv.innerHTML = `<span class="font-bold">${role}:</span> ${htmlContent}`;
            
            chatHistoryDiv.appendChild(messageDiv);
            
            // Animate message pop-in
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            // Call createIcons() after adding new content to the chat history
            createIcons();
        }

        // Event listener for image upload input
        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                // Display the image preview
                imagePreview.src = URL.createObjectURL(file);
                previewContainer.classList.remove('hidden');
                
                // Convert the image to Base64 for the API call
                try {
                    base64Image = await fileToBase64(file);
                    analyzeBtn.disabled = false; // Enable the analyze button
                    resultsContainer.classList.add('hidden'); // Hide previous results
                    errorContainer.classList.add('hidden'); // Hide any previous errors
                    chatHistory = []; // Clear chat history
                    chatHistoryDiv.innerHTML = '';
                    chatToggleButton.classList.add('hidden'); // Hide the chat button on new upload
                    chatPopupWindow.classList.add('chat-hidden'); // Hide the chat popup
                } catch (error) {
                    showError('Failed to read image file.');
                    base64Image = null;
                }
            }
        });
        
        // Event listener for the Analyze button
        analyzeBtn.addEventListener('click', async () => {
            if (!base64Image) {
                showError('Please upload an image first.');
                return;
            }
            
            // Show loading state
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;
            resultsContainer.classList.remove('hidden');
            predictionOutput.innerHTML = '';
            errorContainer.classList.add('hidden');
            
            chatToggleButton.classList.add('hidden'); // Hide the chat button during analysis
            chatPopupWindow.classList.add('chat-hidden'); // Hide the chat popup

            const initialPrompt = "Act as a professional sports analyst for the fantasy sports platform Dream11. You are given a screenshot containing information about an upcoming cricket match. Analyze all the text and images within the screenshot to find key details such as player form, team news, pitch conditions, and recent performances. Based on your thorough analysis, provide the best possible Dream11 team, including a captain and vice-captain. Your output should be a single, well-structured text block that first lists the suggested team by player role (Wicket-keeper, Batsmen, All-rounders, Bowlers) and then provides a concise, point-form analysis explaining your choices. The analysis should be grounded in the data you extracted from the image. For example, explain why you chose a particular player based on their recent score or why a specific bowler is a good choice for the pitch conditions mentioned.";

            try {
                // Initial API call with image and prompt
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: initialPrompt },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Use marked.js to render Markdown
                predictionOutput.innerHTML = marked.parse(responseText);
                
                // Add the initial prompt and response to chat history
                chatHistory = [
                    { role: 'user', parts: [{ text: initialPrompt }] },
                    { role: 'model', parts: [{ text: responseText }] }
                ];
                
                // After analysis, show the chat button
                chatToggleButton.classList.remove('hidden');
                appendChatMessage('AI', responseText);
                chatInput.focus();

            } catch (error) {
                console.error('Initial API call failed:', error);
                showError(`An error occurred: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        });

        // Event listener for sending chat messages
        sendChatBtn.addEventListener('click', async () => {
            const userMessage = chatInput.value.trim();
            if (!userMessage) {
                return;
            }
            
            // Append user message to chat history and UI
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
            appendChatMessage('user', userMessage);
            chatInput.value = '';
            sendChatBtn.disabled = true;
            
            // Show loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'chat-loading';
            loadingMessage.classList.add('p-4', 'text-center', 'text-gray-500', 'text-sm');
            loadingMessage.innerHTML = `
                <div class="loader-container h-8">
                    <div class="loader-dot bg-gray-500"></div>
                    <div class="loader-dot bg-gray-500"></div>
                    <div class="loader-dot bg-gray-500"></div>
                </div>
                <span class="mt-2 block">AI is typing...</span>
            `;
            chatHistoryDiv.appendChild(loadingMessage);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            try {
                // Call API with full chat history
                const payload = {
                    contents: chatHistory,
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Append AI response to chat history and UI
                chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                appendChatMessage('AI', responseText);
                
            } catch (error) {
                console.error('Chat API call failed:', error);
                showError(`An error occurred in the chat: ${error.message}`);
            } finally {
                sendChatBtn.disabled = false;
                const loadingDiv = document.getElementById('chat-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                chatInput.focus();
            }
        });
        
        // Add event listener for the 'Enter' key on the chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatBtn.click();
            }
        });

        // Event listener for the Clear button
        clearBtn.addEventListener('click', () => {
            imageUpload.value = ''; // Reset the file input
            imagePreview.src = '#'; // Clear the image preview
            previewContainer.classList.add('hidden');
            predictionOutput.innerHTML = ''; // Clear the output text
            resultsContainer.classList.add('hidden');
            analyzeBtn.disabled = true;
            base64Image = null;
            errorContainer.classList.add('hidden');
            errorText.textContent = '';
            chatToggleButton.classList.add('hidden'); // Hide chat button on clear
            chatPopupWindow.classList.add('chat-hidden'); // Hide chat popup
            chatHistory = []; // Clear chat history
            chatHistoryDiv.innerHTML = '';
        });

        // Floating chat popup toggle logic
        chatToggleButton.addEventListener('click', () => {
            chatToggleButton.classList.add('hidden');
            chatPopupWindow.classList.remove('chat-hidden');
            chatPopupWindow.classList.add('chat-visible');
            chatInput.focus();
            // Re-render icons after the popup is made visible
            setTimeout(createIcons, 50); 
        });

        chatCloseButton.addEventListener('click', () => {
            chatToggleButton.classList.remove('hidden');
            chatPopupWindow.classList.remove('chat-visible');
            chatPopupWindow.classList.add('chat-hidden');
        });

        // Generic API call function with exponential backoff
        async function callGeminiAPI(payload) {
            const apiKey = "AIzaSyC7twxprKoApUjR4uebBS-12KVyZTkuvrw";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second initial delay

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too many requests
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; // Re-throw the last error after max retries
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Failed to get a valid response from the AI.');
            }
        }
    </script>
</body>
</html>

------------------------------------------------------------------------------------------------------------------

make changes : 

1. make the chat with ai popup responsive for all devices.
2. fix all issues with the buttons and icons within that popup.